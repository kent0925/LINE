<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ´»å‹•å ±åç³»çµ±</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
/* å®šç¾©ç¾ä»£æ„Ÿé…è‰² */
:root {
  --primary-color: #00b900; /* LINE Green */
  --secondary-color: #007aff;
  --danger-color: #ff3b30;
  --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --card-bg: #ffffff;
  --text-main: #333333;
  --text-muted: #666666;
}

body { 
  font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
  padding: 20px 10px; 
  background: var(--bg-gradient);
  min-height: 100vh;
  margin: 0;
  color: var(--text-main);
}

.container { 
  background: var(--card-bg); 
  padding: 25px; 
  border-radius: 16px; 
  max-width: 500px; 
  margin: 0 auto; 
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

h1 { 
  color: var(--primary-color); 
  text-align: center; 
  margin-top: 0;
  margin-bottom: 25px; 
  font-size: 1.5rem;
  letter-spacing: 1px;
}

/* å€å¡Šç¾åŒ– */
.info-card, .form-section, .stats-section { 
  margin-bottom: 20px; 
  padding: 18px; 
  border: 1px solid #edf2f7; 
  border-radius: 12px; 
  background-color: #fafbfc;
}

h2 {
  font-size: 1.1rem;
  margin-top: 0;
  color: #2d3748;
  border-left: 4px solid var(--primary-color);
  padding-left: 10px;
}

label {
  display: block; 
  margin-top: 15px; 
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-muted);
}

input[type="text"], select, textarea {
  width: 100%; 
  padding: 12px; 
  margin-top: 8px; 
  border: 1.5px solid #e2e8f0; 
  border-radius: 8px; 
  box-sizing: border-box;
  font-size: 1rem;
  transition: border-color 0.2s;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  background-color: #fff;
}

/* æŒ‰éˆ•ç¾åŒ– */
.btn {
  padding: 12px 20px; 
  border: none; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 1rem;
  transition: all 0.2s;
  flex: 1;
  margin: 5px;
}

.btn:active { transform: scale(0.95); }

.btn-register { background-color: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(0,185,0,0.3); }
.btn-cancel { background-color: var(--danger-color); color: white; box-shadow: 0 4px 10px rgba(255,59,48,0.3); }
.btn-edit { background-color: var(--secondary-color); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }

.btn-map {
  display: inline-flex;
  align-items: center;
  padding: 5px 12px;
  margin-left: 8px;
  background: #4285F4;
  color: #fff;
  text-decoration: none;
  border-radius: 20px;
  font-size: 0.8rem;
}

#form-actions { display: flex; justify-content: space-between; margin-top: 20px; }

/* çµ±è¨ˆæ¸…å–®ç¾åŒ– */
.stats-list {
  list-style: none;
  padding: 0; 
  max-height: 200px; 
  overflow-y: auto; 
  border-radius: 8px;
  background: #fff;
}

.stats-list li {
  padding: 10px; 
  border-bottom: 1px solid #f1f1f1;
  font-size: 0.95rem;
  display: flex;
  justify-content: space-between;
}

.stats-list li:last-child { border-bottom: none; }

/* è¨Šæ¯é€šçŸ¥ç¾åŒ– */
.message {
  padding: 12px; 
  margin-top: 20px; 
  border-radius: 8px; 
  text-align: center; 
  font-weight: 500; 
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

.loading { text-align: center; padding: 40px; color: var(--text-muted); }
</style>
</head>
<body>

<div class="container">
  <h1>æ´»å‹•å ±åç³»çµ±</h1>

  <div id="loading-spinner" class="loading">
    <p>æ­£åœ¨é€£ç·šè‡³ LINE...</p>
  </div>

  <div id="event-selection" class="form-section" style="display:none;">
    <h2>é¸æ“‡æ´»å‹•</h2>
    <label for="event-select">è«‹é¸æ“‡æ‚¨è¦åƒåŠ çš„æ´»å‹•</label>
    <select id="event-select" onchange="selectEvent(this.value)">
      <option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>
    </select>
  </div>

  <div id="activity-info" class="info-card" style="display:none;">
    <h2>æ´»å‹•è©³æƒ… - <span id="info-title"></span></h2>
    <p>ğŸ“… <strong>æ™‚é–“ï¼š</strong><span id="info-time"></span></p>
    <p>ğŸ¢ <strong>åº—åï¼š</strong><span id="info-venue-name"></span></p>
    <p>ğŸ“ <strong>åœ°é»ï¼š</strong><span id="info-location"></span> 
       <a id="info-map-link" href="#" target="_blank" class="btn-map">åœ°åœ–</a></p>
    <p>ğŸ‘¤ <strong>ä¸»è¾¦ï¼š</strong><span id="info-organizer"></span></p>
  </div>

  <div id="registration-form" class="form-section" style="display:none;">
    <h2>æ‚¨çš„å ±åè³‡æ–™</h2>
    <p><strong>åƒåŠ è€…ï¼š</strong> <span id="line-nickname" style="color:var(--secondary-color)">è¼‰å…¥ä¸­...</span></p>
    <input type="hidden" id="line-uid">

    <label for="attendees-count">åƒåŠ äººæ•¸</label>
    <select id="attendees-count"></select>

    <label for="guest-names">ä¾†è³“å§“åï¼ˆé¸å¡«ï¼‰</label>
    <textarea id="guest-names" rows="2" placeholder="è‹¥æœ‰å¤šäººè«‹ç”¨é€—è™Ÿåˆ†éš”"></textarea>

    <div id="form-actions">
      <button id="btn-register" class="btn btn-register" onclick="submitRegistration('register')">ç¢ºå®šå ±å</button>
      <button id="btn-edit" class="btn btn-edit" onclick="submitRegistration('edit')">å„²å­˜ä¿®æ”¹</button>
      <button id="btn-cancel" class="btn btn-cancel" onclick="submitRegistration('cancel')">å–æ¶ˆå ±å</button>
    </div>

    <div id="form-message" class="message"></div>
  </div>

  <div id="statistics" class="stats-section" style="display:none;">
    <h2>ç›®å‰å ±åç‹€æ³</h2>
    <p>ç›®å‰ç¸½è¨ˆï¼š<strong style="color:var(--primary-color); font-size: 1.2rem;"><span id="total-attendees">0</span></strong> äºº</p>
    <ul id="registered-list" class="stats-list"></ul>
  </div>
</div>

<script>
// æ­¤è™•å…§å®¹å®Œå…¨ä¿ç•™æ‚¨åŸæœ¬çš„ JavaScript é‚è¼¯ï¼Œåƒ…ä¿®æ”¹ formatLocalTime çš„é¡¯ç¤ºæ ¼å¼è®“å®ƒæ›´ç²¾ç·»
const GAS_URL='https://script.google.com/macros/s/AKfycbz4TwMhhZns3p2jc2tVTI376-6DU9CG8tkuRmL3KKcq_BmIuB2ySV2CKgaCc5eyS2vLnA/exec';
const LIFF_ID='2008678090-aXTesgDK';
let LINE_UID='', LINE_NICKNAME='', CURRENT_EVENT_ID=null, ALL_EVENTS=[];

async function initializeLiff(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const profile = await liff.getProfile();
    LINE_UID = profile.userId;
    LINE_NICKNAME = profile.displayName;
    document.getElementById('line-nickname').textContent = LINE_NICKNAME;
    loadEventsList();
  } catch(err){
    alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š' + err);
  }
}

function formatLocalTime(iso){
  const d = new Date(iso);
  const months = d.getMonth() + 1;
  const days = d.getDate();
  const hours = String(d.getHours()).padStart(2, '0');
  const mins = String(d.getMinutes()).padStart(2, '0');
  return `${d.getFullYear()}/${months}/${days} ${hours}:${mins}`;
}

async function loadEventsList(){
  try {
    const res = await fetch(`${GAS_URL}?action=getEventsList&lineUid=${LINE_UID}`);
    const data = await res.json();
    ALL_EVENTS = data.events || [];

    const sel = document.getElementById('event-select');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>';

    ALL_EVENTS.forEach(ev=>{
      sel.innerHTML += `<option value="${ev.EventID}">
        ${ev.Title} (${formatLocalTime(ev.Time)})
      </option>`;
    });

    const countSel = document.getElementById('attendees-count');
    countSel.innerHTML='';
    for(let i=1;i<=10;i++){ countSel.innerHTML+=`<option value="${i}">${i} äºº</option>`;}

    document.getElementById('loading-spinner').style.display='none';
    document.getElementById('event-selection').style.display='block';
  } catch(err){
    console.error('è¼‰å…¥å¤±æ•—:', err);
  }
}

function selectEvent(eventId){
  const ev = ALL_EVENTS.find(e=>e.EventID===eventId);
  if(!ev) return;
  CURRENT_EVENT_ID = eventId;
  document.getElementById('activity-info').style.display='block';
  document.getElementById('registration-form').style.display='block';
  document.getElementById('info-title').textContent = ev.Title;
  document.getElementById('info-organizer').textContent = ev.Organizer;
  document.getElementById('info-time').textContent = formatLocalTime(ev.Time);
  document.getElementById('info-venue-name').textContent = ev.VenueName;
  document.getElementById('info-location').textContent = ev.Address;
  document.getElementById('info-map-link').href = ev.MapUrl;
  loadStatsAndStatus(eventId);
}

async function loadStatsAndStatus(eventId){
  try {
    const res = await fetch(`${GAS_URL}?action=getStatsAndStatus&lineUid=${LINE_UID}&eventId=${eventId}`);
    const data = await res.json();
    document.getElementById('total-attendees').textContent = data.totalAttendees || 0;
    const ul = document.getElementById('registered-list');
    ul.innerHTML='';
    (data.registeredUsers||[]).forEach(u=>{
      ul.innerHTML+=`<li><span>${u.name}</span> <span style="color:var(--text-muted)">${u.attendees}äºº</span></li>`;
    });
    updateButtons(data.userStatus);
    document.getElementById('statistics').style.display='block';
  } catch(err){
    console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', err);
  }
}

function updateButtons(userStatus){
  if(userStatus && userStatus.Status==='Registered'){
    document.getElementById('btn-register').style.display='none';
    document.getElementById('btn-cancel').style.display='inline-block';
    document.getElementById('btn-edit').style.display='inline-block';
    document.getElementById('attendees-count').value = userStatus.Attendees_Count||1;
    document.getElementById('guest-names').value = userStatus.Guest_Names||'';
  } else {
    document.getElementById('btn-register').style.display='inline-block';
    document.getElementById('btn-cancel').style.display='none';
    document.getElementById('btn-edit').style.display='none';
    document.getElementById('attendees-count').value = 1;
    document.getElementById('guest-names').value = '';
  }
}

async function submitRegistration(action){
  if(!CURRENT_EVENT_ID) return;
  
  // ç°¡å–®çš„ UI åé¥‹
  const msg = document.getElementById('form-message');
  msg.style.display = 'block';
  msg.className = 'message';
  msg.textContent = 'è™•ç†ä¸­...';

  const payload = {
    action,
    eventId: CURRENT_EVENT_ID,
    lineUid: LINE_UID,
    lineNickname: LINE_NICKNAME,
    attendeesCount: parseInt(document.getElementById('attendees-count').value),
    guestNames: document.getElementById('guest-names').value
  };
  try {
    const res = await fetch(GAS_URL,{method:'POST',body:JSON.stringify(payload)});
    const data = await res.json();
    msg.className = data.status==='success'?'message success':'message error';
    msg.textContent = data.message;
    loadStatsAndStatus(CURRENT_EVENT_ID);
    loadEventsList();
  } catch(err){
    msg.className = 'message error';
    msg.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚';
  }
}

initializeLiff();
</script>
</body>
</html>
